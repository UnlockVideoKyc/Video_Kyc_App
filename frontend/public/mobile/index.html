<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DigiKhata - Video KYC</title>
    <link rel="stylesheet" href="/mobile/css/style.css">
</head>
<body>
    <!-- HOME SCREEN -->
    <div id="homeScreen" class="screen active">
        <div class="container">
            <div class="logo">
                <h1>DigiKhata</h1>
                <p>Video KYC Verification</p>
            </div>
            <button class="btn-primary" onclick="showPermissionsScreen()">
                Start VKYC
            </button>
        </div>
    </div>

    <!-- PERMISSIONS SCREEN -->
    <div id="permissionsScreen" class="screen">
        <div class="container">
            <h2>Allow Permissions</h2>
            <p class="subtitle">We need these permissions to proceed</p>

            <div class="permission-list">
                <div class="permission-item">
                    <div class="permission-icon mic"></div>
                    <div class="permission-text">
                        <h3>Microphone</h3>
                        <p id="micStatus">Not Allowed</p>
                    </div>
                    <button class="btn-toggle" id="micBtn" onclick="requestMicPermission()">
                        Enable
                    </button>
                </div>

                <div class="permission-item">
                    <div class="permission-icon camera"></div>
                    <div class="permission-text">
                        <h3>Camera</h3>
                        <p id="cameraStatus">Not Allowed</p>
                    </div>
                    <button class="btn-toggle" id="cameraBtn" onclick="requestCameraPermission()">
                        Enable
                    </button>
                </div>

                <div class="permission-item">
                    <div class="permission-icon location"></div>
                    <div class="permission-text">
                        <h3>Location</h3>
                        <p id="locationStatus">Not Allowed</p>
                    </div>
                    <button class="btn-toggle" id="locationBtn" onclick="requestLocationPermission()">
                        Enable
                    </button>
                </div>
            </div>

            <div id="permissionError" class="error-msg" style="display:none;"></div>

            <button class="btn-primary" id="continueBtn" onclick="initializeSession()" disabled>
                Continue
            </button>
        </div>
    </div>

    <!-- WAITING SCREEN -->
    <div id="waitingScreen" class="screen">
        <div class="container">
            <div class="loader"></div>
            <h2>Connecting to Agent...</h2>
            <p class="subtitle">Please wait while we connect you</p>
            <div class="info-box">
                <p><strong>VCIP ID:</strong> <span id="vcipIdDisplay">-</span></p>
                <p><strong>Connection ID:</strong> <span id="connectionIdDisplay">-</span></p>
            </div>
        </div>
    </div>

    <!-- VIDEO CALL SCREEN -->
    <div id="videoCallScreen" class="screen">
        <div class="video-container">
            <video 
                id="remoteVideo" 
                autoplay 
                playsinline
                style="width: 100%; height: 100%; object-fit: cover; background: #000;"
            ></video>
            
            <video id="localVideo" autoplay playsinline muted class="local-preview"></video>

            <div class="video-label agent-label">Agent</div>
            <div class="video-label customer-label">You</div>

            <div class="call-info">
                <div class="call-timer" id="callTimer">00:00:00</div>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span> Connected
                </div>
            </div>

            <div class="quality-indicator" id="qualityIndicator">
                <span class="quality-dot"></span>
                <span id="qualityText">Good</span>
            </div>
        </div>

        <div class="call-controls">
            <button class="control-btn" id="muteBtn" onclick="toggleMute()">
                <span class="icon"></span>
                <span class="label">Mute</span>
            </button>
            <button class="control-btn" id="videoBtn" onclick="toggleVideo()">
                <span class="icon"></span>
                <span class="label">Video</span>
            </button>
            <button class="control-btn disabled" title="Only agent can end call">
                <span class="icon"></span>
                <span class="label">End Call</span>
            </button>
        </div>

        <div class="message-box" id="messageBox" style="display:none;">
            <p id="agentMessage"></p>
        </div>
    </div>

    <!-- CALL ENDED SCREEN -->
    <div id="callEndedScreen" class="screen">
        <div class="container">
            <div class="success-icon"></div>
            <h2>Call Ended</h2>
            <p class="subtitle">Thank you for completing the Video KYC</p>
            <div class="info-box">
                <p><strong>Duration:</strong> <span id="finalDuration">-</span></p>
                <p><strong>Status:</strong> <span id="finalStatus">-</span></p>
            </div>
            <button class="btn-primary" onclick="location.reload()">
                Start New Session
            </button>
        </div>
    </div>

    <!-- CALL ENDED BY AGENT MODAL -->
    <div id="callEndedByAgentModal" class="call-ended-modal">
        <div class="call-ended-content">
            <div class="call-ended-icon"></div>
            <h2 class="call-ended-title">Call Ended by Agent</h2>
            
            <div class="call-ended-reason-box">
                <div class="reason-label">
                    <span class="reason-label-icon"></span>
                    <span>Reason for ending the call:</span>
                </div>
                <div class="reason-text" id="endCallReason"></div>
            </div>

            <p class="call-ended-subtitle">
                The agent has ended the video call. If you need further assistance, 
                please contact customer support.
            </p>

            <button class="call-ended-btn" onclick="handleCallEndedOkay()">
                Okay
            </button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/mobile/js/socket.js"></script>
    <script src="/mobile/js/webrtc.js"></script>
    <script src="/mobile/js/app.js"></script>
</body>
</html>